# Final System: Linux Kernel
# This section is done in Chroot environment

# Prepare for compilation by running the following command:
make mrproper

# Configure kernel:
make menuconfig

# Compile the kernel image and modules: 
make

# Install the modules, if the kernel configuration uses them:
make modules_install

# Install the kernel:
cp -iv arch/x86/boot/bzImage /boot/vmlinuz

# Install the symbol file for the kernel:
cp -iv System.map /boot/System.map

# Install the kernel configuration file .config produced by the make menuconfig:
cp -iv .config /boot/config


# If creating an iitramfs image for boot, install cpio
patch -Np0 -i ../cpio-2.12-void-CVE-2016-2037-1-byte-out-of-bounds-write.patch
patch -Np0 -i ../cpio-2.12-void-Fix-out-of-bounds-read.patch
patch -Np0 -i ../cpio-2.12-void-Fix-sigfault-when-appending-to-archive.patch
patch -Np0 -i ../cpio-2.12-void-Fix-signed-integer-overflow-big-block-sizes.patch
autoreconf -vfi
./configure --prefix=/usr --sysconfdir=/etc 
make && make install

# Then create the initramfs image...
# Use the name of the kernel, which can be found in /lib/modules:
# i.e.  /lib/modules/4.19.0
mkinitramfs <kernel name>
# i.e.  mkinitramfs 4.19.0
